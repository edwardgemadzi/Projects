<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maptiler weather layers</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
  <script src="https://cdn.maptiler.com/maptiler-weather/v3.0.1/maptiler-weather.umd.min.js"></script>
  <style>
    body { 
        margin: 0; 
        padding: 10px; 
        font-family: sans-serif; 
        background: #000;
        color: #fff;
    }
    #map { 
        position: relative; 
        top: 0; 
        bottom: 0; 
        width: 100%; 
        height: 80vh; 
        background-color: #000000;
    }
    #pointer-data{ 
        z-index: 1; 
        position: fixed; 
        font-size: 20px; 
        font-weight: 900; 
        margin: 27px 0px 0px 10px; 
        color: #fff; 
        text-shadow: 0px 0px 10px #0007;}
    #variable-name{ 
        z-index: 1; 
        position: fixed; 
        font-size: 20px; 
        font-weight: 500; 
        margin: 5px 0px 0px 10px; 
        color: #fff; 
        text-shadow: 0px 0px 10px #0007; 
        text-transform:capitalize;
    }
    #time-info { 
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
        width: 60vw;
        z-index: 2;
        text-shadow: 0px 0px 5px black;
        color: white;
        font-size: 18px;
        font-weight: 500;
        text-align: center;
        padding: 20px;
    }
    #time-text{ 
        font-size: 12px; 
        font-weight: 600;
    }
    #time-slider{ 
        width: 100%; 
        height: fit-content; 
        left: 0; 
        right: 0; 
        z-index: 1; 
        filter: drop-shadow(0 0 7px #000a); 
        margin-top: 10px;
    }
    #buttons{ 
        width: auto; 
        margin: 0 10px; 
        padding:0; 
        position:absolute; 
        top: 50px; 
        left:0; 
        z-index:99;
    }
    .button{ 
        display: block; 
        position: relative; 
        margin: 10px 0 0 0; 
        font-size: 0.9em;
    }
    #weather-search {
        display: flex;
        gap: 0.5rem;
    }
  </style>
</head>
<body>
    <nav style="display: flex; justify-content: space-between; align-items: center; padding: 1rem;">
        <h1>Weather App</h1>
        <div id="weather-search">
          <input type="text" id="citySearch" placeholder="Enter city">
          <button onclick="searchCityWeather()" class="btn btn-sm btn-primary">Search</button>
        </div>
    </nav>

    <div id="map">

        <div id="variable-name">Wind</div>
        <div id="pointer-data"></div>
        <ul id="buttons">
        <li id="precipitation" class="btn btn-primary button">Precipitation</li>
        <li id="pressure" class="btn btn-primary button">Pressure</li>
        <li id="radar" class="btn btn-primary button">Radar</li>
        <li id="temperature" class="btn btn-primary button">Temperature</li>
        <li id="wind" class="btn btn-primary button">Wind</li>
        </ul>

        <div id="current-summary" style="position:absolute; top:10px; left:50%; transform:translateX(-50%); text-align:center; z-index:0; color:white; display: none;">        
            <div id="current-box" style="backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); background: rgba(0,0,0,0.4); border-radius: 12px; padding: 0.7rem 1rem; border: solid 1px rgba(255, 255, 255, 0.2); width: 30vw; margin: 0 auto; font-size: 0.75rem; max-height: 15%; overflow-y: auto;">
            <div id="current-location" style="font-size: 1rem; font-weight: 600;"></div>
            <div id="current-condition" style="margin-top: 0.5rem;"></div>
            <div id="current-extra" style="margin-top: 0.5rem; display: flex; justify-content: space-around; flex-wrap: wrap;"></div>
            <div id="forecastResult" style="margin-top: 1rem;"></div>
          </div>
        </div>

        <div id="time-info">
            <span id="time-text"></span>
            <button id="play-pause-bt" class="btn btn-primary btn-sm time-button">Play 3600x</button>
            <input type="range" id="time-slider" min="0" max="11" step="1">
        </div>
    </div>
    <!-- Removed weather-output container -->
  <script>
      maptilersdk.config.apiKey = 'Huff1UH5699TSQtbOMtP';

      const weatherLayers = {
        "precipitation": {
          "layer": null,
          "value": "value",
          "units": " mm"
        },
        "pressure": {
          "layer": null,
          "value": "value",
          "units": " hPa"
        },
        "radar": {
          "layer": null,
          "value": "value",
          "units": " dBZ"
        },
        "temperature": {
          "layer": null,
          "value": "value",
          "units": "Â°"
        },
        "wind": {
          "layer": null,
          "value": "speedMetersPerSecond",
          "units": " m/s"
        }
      };

      const map = (window.map = new maptilersdk.Map({
        container: 'map', // container's id or the HTML element to render the map
        style: maptilersdk.MapStyle.BACKDROP,  // stylesheet location
        zoom: 0,
        center: [0, 0], // Central Africa
        maxZoom: 11.9,
        hash: true,
        projectionControl: true,
        projection: 'globe'
      }));

//       map._controls
//   .filter(ctrl => ctrl.constructor.name === 'GeolocateControl')
//   .forEach(ctrl => map.removeControl(ctrl));


      const initWeatherLayer = "wind";
      const timeInfoContainer = document.getElementById("time-info");
      const timeTextDiv = document.getElementById("time-text");
      const timeSlider = document.getElementById("time-slider");
      const playPauseButton = document.getElementById("play-pause-bt");
      const pointerDataDiv = document.getElementById("pointer-data");
      let pointerLngLat = null;
      let activeLayer = null;
      let isPlaying = false;
      let currentTime = null;

      timeSlider.addEventListener("input", (evt) => {
        const weatherLayer = weatherLayers[activeLayer]?.layer;
        if (weatherLayer) {
          weatherLayer.setAnimationTime(parseInt(timeSlider.value / 1000));
        }
      });

      // When clicking on the play/pause
      playPauseButton.addEventListener("click", () => {
        const weatherLayer = weatherLayers[activeLayer]?.layer;
        if (weatherLayer) {
          if (isPlaying) {
            pauseAnimation(weatherLayer);
          } else {
            playAnimation(weatherLayer);
          }
        }
      });

      function pauseAnimation(weatherLayer) {
        weatherLayer.animateByFactor(0);
        playPauseButton.innerText = "Play 3600x";
        isPlaying = false;
      }

      function playAnimation(weatherLayer) {
        weatherLayer.animateByFactor(3600);
        playPauseButton.innerText = "Pause";
        isPlaying = true;
      }

      map.on('load', function () {
        map.setPaintProperty("Water", 'fill-color', "rgba(0, 0, 0, 0.4)");
        initWeatherMap(initWeatherLayer);
      });

      map.on('mouseout', function(evt) {
        if (!evt.originalEvent.relatedTarget) {
          pointerDataDiv.innerText = "";
          pointerLngLat = null;
        }
      });

      function updatePointerValue(lngLat) {
        if (!lngLat) return;
        pointerLngLat = lngLat;
        const weatherLayer = weatherLayers[activeLayer]?.layer;
        const weatherLayerValue = weatherLayers[activeLayer]?.value;
        const weatherLayerUnits = weatherLayers[activeLayer]?.units;
        if (weatherLayer) {
          const value = weatherLayer.pickAt(lngLat.lng, lngLat.lat);
          if (!value) {
            pointerDataDiv.innerText = "";
            return;
          }
          pointerDataDiv.innerText = `${value[weatherLayerValue].toFixed(1)}${weatherLayerUnits}`
        }
      }

      map.on('mousemove', (e) => {
        updatePointerValue(e.lngLat);
      });

      document.getElementById('buttons').addEventListener('click', function (event) {
        // Change layer based on button id
        changeWeatherLayer(event.target.id);
      });

      function changeWeatherLayer(type) {
        if (type !== activeLayer) {
          if (map.getLayer(activeLayer)) {
            const activeWeatherLayer = weatherLayers[activeLayer]?.layer;
            if (activeWeatherLayer) {
              currentTime = activeWeatherLayer.getAnimationTime();
              map.setLayoutProperty(activeLayer, 'visibility', 'none');
            }
          }
          activeLayer = type;
          const weatherLayer = weatherLayers[activeLayer].layer || createWeatherLayer(activeLayer);
          if (map.getLayer(activeLayer)) {
            map.setLayoutProperty(activeLayer, 'visibility', 'visible');
          } else {
            map.addLayer(weatherLayer, 'Water');
          }
          changeLayerLabel(activeLayer);
          activateButton(activeLayer);
          changeLayerAnimation(weatherLayer);
          return weatherLayer;
        }
      }

      function activateButton(activeLayer) {
        const buttons = document.getElementsByClassName('button');
        for (let i = 0; i < buttons.length; i++) {
          const btn = buttons[i];
          if (btn.id === activeLayer) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        }
      }

      function changeLayerAnimation(weatherLayer) {
        weatherLayer.setAnimationTime(parseInt(timeSlider.value / 1000));
        if (isPlaying) {
          playAnimation(weatherLayer);
        } else {
          pauseAnimation(weatherLayer);
        }
      }

      function createWeatherLayer(type){
        let weatherLayer = null;
        switch (type) {
          case 'precipitation':
            weatherLayer = new maptilerweather.PrecipitationLayer({id: 'precipitation'});
            break;
          case 'pressure':
            weatherLayer = new maptilerweather.PressureLayer({
              opacity: 0.8,
              id: 'pressure'
            });
            break;
          case 'radar':
            weatherLayer = new maptilerweather.RadarLayer({
              opacity: 0.8,
              id: 'radar'
            });
            break;
          case 'temperature':
            weatherLayer = new maptilerweather.TemperatureLayer({
              colorramp: maptilerweather.ColorRamp.builtin.TEMPERATURE_3,
              id: 'temperature'
            });
            break;
          case 'wind':
            weatherLayer = new maptilerweather.WindLayer({id: 'wind'});
            break;
        }

        // Called when the animation is progressing
        weatherLayer.on("tick", event => {
          refreshTime();
          updatePointerValue(pointerLngLat);
        });

        // Called when the time is manually set
        weatherLayer.on("animationTimeSet", event => {
          refreshTime();
        });

        // Event called when all the datasource for the next days are added and ready.
        // From now on, the layer nows the start and end dates.
        weatherLayer.on("sourceReady", event => {
          const startDate = weatherLayer.getAnimationStartDate();
          const endDate = weatherLayer.getAnimationEndDate();
          if (timeSlider.min > 0){
            weatherLayer.setAnimationTime(currentTime);
            changeLayerAnimation(weatherLayer);
          } else {
            const currentDate = weatherLayer.getAnimationTimeDate();
            timeSlider.min = +startDate;
            timeSlider.max = +endDate;
            timeSlider.value = +currentDate;
          }
        });

        weatherLayers[type].layer = weatherLayer;
        return weatherLayer;
      }

      // Update the date time display
      function refreshTime() {
        const weatherLayer = weatherLayers[activeLayer]?.layer;
        if (weatherLayer) {
          const d = weatherLayer.getAnimationTimeDate();
          timeTextDiv.innerText = d.toString();
          timeSlider.value = +d;
        }
      }

      function changeLayerLabel(type) {
        document.getElementById("variable-name").innerText = type;
      }

      function initWeatherMap(type) {
        const weatherLayer = changeWeatherLayer(type);
      }

      async function searchCityWeather() {
        const city = document.getElementById('citySearch').value.trim();
        if (!city) {
          alert('Please enter a city name.');
          return;
        }

        const url = `http://api.weatherapi.com/v1/current.json?key=223dfb67eeca4ea0958223650250804&q=${city}&aqi=no`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (data.error) throw new Error(data.error.message);

        //   const output = `${data.location.name}, ${data.location.country}<br><img src="https:${data.current.condition.icon}" alt="${data.current.condition.text}" style="width: 24px; vertical-align: middle;"> ${data.current.temp_c}Â°C, ${data.current.condition.text}`;
          document.getElementById('current-location').innerText = `${data.location.name}, ${data.location.country}`;
          document.getElementById('current-condition').innerHTML = `<img src="https:${data.current.condition.icon}" alt="${data.current.condition.text}" style="width: 24px; vertical-align: middle;"> ${data.current.temp_c}Â°C, ${data.current.condition.text}`;
          document.getElementById('citySearch').value = '';

          // Center map on search result
          centerMapOnLocation(data.location.lon, data.location.lat);
          await getForecast(data.location.name);
          const currentSummary = document.getElementById('current-summary');
          currentSummary.style.display = 'block';
          currentSummary.style.zIndex = '3';       
        } catch (error) {
          document.getElementById('searchResult').innerText = error.message;
        }
      }

      async function getForecast(city) {
        const url = `http://api.weatherapi.com/v1/forecast.json?key=223dfb67eeca4ea0958223650250804&q=${city}&days=4&aqi=no`;
        const res = await fetch(url);
        const forecast = await res.json();

        if (!forecast.forecast) return;

        const current = forecast.current;
        const summary = `
            <div>Feels Like: ${current.feelslike_c}Â°C</div>
            <div>Wind: ${current.wind_kph} km/h ${current.wind_dir}</div>
            <div>UV: ${current.uv}</div>
            <div>Visibility: ${current.vis_km} km</div>
            <div>Humidity: ${current.humidity}%</div>
        `;
        document.getElementById('current-extra').innerHTML = summary;

        let table = '<h4 style="margin-top:1rem; font-size: 1rem;">Forecast</h4>';
        table += '<table style="width:100%; color:white; border-collapse: collapse;">';
        table += `<thead><tr>
          <th style="border-bottom: 1px solid #555; padding: 10px;">Day</th>
          <th style="border-bottom: 1px solid #555; padding: 10px;">Condition</th>
          <th style="border-bottom: 1px solid #555; padding: 10px;">High</th>
          <th style="border-bottom: 1px solid #555; padding: 10px;">Low</th>
        </tr></thead><tbody>`;

        forecast.forecast.forecastday.forEach(day => {
          const date = new Date(day.date);
          const dayName = date.toLocaleDateString("en-US", { weekday: "short" });
          table += `<tr>
            <td style="text-align: center; padding: 10px;">${dayName}</td>
            <td style="text-align: center; padding: 10px;">
              <img src="https:${day.day.condition.icon}" alt="${day.day.condition.text}" style="width: 24px; vertical-align: middle;"> ${day.day.condition.text}
            </td>
            <td style="text-align: center; padding: 10px;">${day.day.maxtemp_c}Â°C</td>
            <td style="text-align: center; padding: 10px;">${day.day.mintemp_c}Â°C</td>
          </tr>`;
        });

        table += '</tbody></table>';
        document.getElementById('forecastResult').innerHTML = table;
    }
  document.getElementById("citySearch").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      searchCityWeather();
    }
  });
  
  function centerMapOnLocation(lng, lat) {
  map.flyTo({
    center: [lng, lat],
    zoom: 11.9,
    bearing: 0,
    pitch: 90,
    speed: 1.9,
    curve: 1.42,
    easing: t => t
  });
}
  </script>
</body>
</html>